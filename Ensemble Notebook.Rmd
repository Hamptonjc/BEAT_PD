---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

## Ensemble Notebook

```{python}
import torch
import torch.nn as nn
import numpy as np
import pandas as pd
import pytorch_lightning as pl
from tensorboard import notebook


# %run -i Dataset_ensemble.py
# %run -i Torch_Dataset.py
# %run -i BEATPD_LSTM.py
# %run -i EvalUtilities.py
# %run -i LightningEnsemble.py
```

```{python}
############### CIS config ###############

dataset_name = 'CIS'
label_class = 'on_off'
sort_by = 'subject_id'
train_ts_dir = 'Data/BEATPDchallenge/training_data-cispd/'
train_label_dir = 'Data/BEATPDchallenge/data_labels-cispd/CIS-PD_Training_Data_IDs_Labels.csv'
ancil_ts_dir = 'Data/BEATPDchallenge/ancillary_data-cispd/'
ancil_label_dir = 'Data/BEATPDchallenge/data_labels-cispd/CIS-PD_Ancillary_Data_IDs_Labels.csv'
test_ts_dir='Data/BEATPDchallenge/testing_data-cispd/'
test_data_id_dir='Data/BEATPDchallenge/CIS-PD_Test_Data_IDs.csv'
```

```{python}
dataset = Dataset(dataset_name=dataset_name, sort_by=sort_by, label_class = label_class,
                           train_ts_dir=train_ts_dir, train_label_dir=train_label_dir,
                           ancil_ts_dir=ancil_ts_dir, ancil_label_dir=ancil_label_dir,
                           combine_ancil=False)#,test_ts_dir=test_ts_dir, test_data_id_dir=test_data_id_dir)
```

```{python}
dataset.run_ensemble_preprocessing(specific_key_dataset=1020)
```

```{python}
dataset.train_validation_split(val_proportion=0.2)
```

```{python}
print('Training size:',len(dataset.train_list))
print('Validation size:',len(dataset.val_list))
```

```{python}
# Hyperparameters
hparams = Namespace(**{'learning_rate': 0.0001, 'train_batch_size': 1,
                       'val_batch_size': 1})
```

```{python}
subject_id = 1020
```

```{python}
# Run training/validation of model
model = LightningVGG16(dataset_name=dataset_name,hparams=hparams,train_list=dataset.train_list,
                       val_list=dataset.val_list,label_class=label_class)
logger = TensorBoardLogger("lightning_logs", name="ensemble", version=f'subject_{subject_id}_{label_class}_ensemble')
trainer = pl.Trainer(early_stop_callback=True, max_epochs=10, gpus=1, logger=logger)
trainer.fit(model)
```

```{python}
# Start tensorboard
notebook.start('--logdir lightning_logs --host localhost --port 7004')
```

```{python}
# Start tensorboard
notebook.display(port=7004)
```
