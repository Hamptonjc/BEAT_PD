---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# BEAT-PD VGG16

```{python}
# Disable autosave
# #%autosave 0
```

```{python}
# Jupyter Theme switch

#Light theme
# #!jt -t grade3

#Dark theme
# #!jt -t chesterish

```

```{python}
# Imports
import os
import sys
import time
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
# %matplotlib inline

import torch
import pytorch_lightning as pl
from pytorch_lightning.logging import TensorBoardLogger
from tensorboard import notebook
from argparse import Namespace
import torch.nn as nn
import torchvision as tv
import torchvision.transforms.functional as TF
from torch.nn import functional as F
from torchvision import transforms, models
from torch.utils import data
from torch.utils.data import DataLoader
from PIL import Image
import glob
import random
```

```{python}
# Run .py files
# %run -i Training_Dataset.py
# %run -i Torch_Dataset.py
# %run -i EvalUtilities.py
# %run -i LightningVGG16.py
```

```{python}
# %run -i Torch_Dataset.py
```

# Training Dataset

```{python}
## REAL config

# dataset_name = 'REAL'
# label_class = 'on_off'
# sort_by = 'on_off'
# train_ts_dir = 'Data/BEATPDchallenge/BeatPDRealPDupdated/real-pd.training_data_updated/training_data/'
# train_label_dir = 'Data/BEATPDchallenge/data_labels-realpd/REAL-PD_Training_Data_IDs_Labels.csv'
# ancil_ts_dir = 'Data/BEATPDchallenge/BeatPDRealPDupdated/real-pd.ancillary_data_updated/ancillary_data/'
# ancil_label_dir = 'Data/BEATPDchallenge/data_labels-realpd/REAL-PD_Ancillary_Data_IDs_Labels.csv'
```

```{python}
# CIS config

dataset_name = 'CIS'
label_class = 'on_off'
sort_by = 'subject_id'
train_ts_dir = 'Data/BEATPDchallenge/training_data-cispd/'
train_label_dir = 'Data/BEATPDchallenge/data_labels-cispd/CIS-PD_Training_Data_IDs_Labels.csv'
ancil_ts_dir = 'Data/BEATPDchallenge/ancillary_data-cispd/'
ancil_label_dir = 'Data/BEATPDchallenge/data_labels-cispd/CIS-PD_Ancillary_Data_IDs_Labels.csv'
```

```{python}
dataset = Training_Dataset(dataset_name=dataset_name, sort_by=sort_by, label_class = label_class,
                           train_ts_dir=train_ts_dir, train_label_dir=train_label_dir,
                           ancil_ts_dir=ancil_ts_dir, ancil_label_dir=ancil_label_dir,
                           combine_ancil=True)
```

```{python}
dataset.data_dict.keys()
```

```{python}
dataset.run_preprocessing(specific_key_dataset=1004)
```

# Train Validation Split

```{python}
dataset.train_validation_split(val_proportion=0.2)
```

```{python}
print('Training size:',len(dataset.train_list))
print('Validation size:',len(dataset.val_list))
```

# Edit VGG16

```{python}
# Load instance of VGG16
torch.manual_seed(314)
VGG16 = models.vgg16(pretrained=True)
```

```{python}
# View final classifer section
VGG16.classifier[6]
```

```{python}
# Turn of gradients for VGG16 parameters
for param in VGG16.parameters():
    param.requires_grad = False
```

```{python}
# Modify last layer to have an output size of 5 (for our 5 classes)
torch.manual_seed(314)
VGG16.classifier[6] = nn.Sequential(nn.Linear(4096,512),nn.ReLU(),
                                    nn.Linear(512,5))
```

```{python}
# View classifer section of VGG16
VGG16.classifier
```

# Run Training/Validation

```{python}
# Hyperparameters
hparams = Namespace(**{'learning_rate': 0.001, 'train_batch_size': 10,
                       'val_batch_size': 10})
```

```{python}
# Start tensorboard
notebook.start('--logdir lightning_logs --host localhost --port 6966')
```

```{python}
# Display tensorboard
notebook.display(port=6966)
```

```{python}
# Run training/validation of model
model = LightningVGG16(hparams,train_list=dataset.train_list, val_list=dataset.val_list,
                       label_class=label_class)
logger = TensorBoardLogger("lightning_logs", name="VGG16", version='score tst')
trainer = pl.Trainer(early_stop_callback=True, max_epochs=10, gpus=1, logger=logger)
trainer.fit(model)
```

```{python}
# List tensorboard instances
#notebook.list()
```

```{python}
#tensorboard kill
# #!taskkill /pid 11468 /f
```

```{python}
#torch.cuda.empty_cache()
```

```{python}
tst = Torch_Dataset(dataset.val_list, label_class=label_class)
```

```{python}
tstloader = DataLoader(tst)
```

```{python}
next(iter(tstloader))
```

# Predictions

```{python}
# Load submission template
submission = pd.read_csv('Data/BEAT-PD_SC1_OnOff_Submission_Template.csv')
submission.head()
```

```{python}
# Predict and fill in submission template
for measurement, id_ in testdataset:
    output = model(torch.unsqueeze(TF.to_tensor(measurement).cuda(), dim=0))
    prediction = output.argmax(dim=1, keepdim=True).item()
    df_index = submission.index[submission['measurement_id'] == id_]
    submission.prediction[df_index] = prediction
```

```{python}
# View predictions
pd.options.display.max_rows = 800
submission.head(n=800)
```

```{python}
#Save submission df to CSV
submission.to_csv('Data/sc1_cis_submissions.csv', index=False)
```
